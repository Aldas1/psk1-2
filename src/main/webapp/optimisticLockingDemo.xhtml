<!-- optimisticLockingDemo.xhtml -->
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

<h:head>
    <title>Optimistic Locking Demo</title>
    <h:outputStylesheet library="css" name="styles.css"/>
</h:head>

<h:body>
    <div class="container">
        <div class="header">
            <h1>Optimistic Locking Demonstration</h1>
            <div class="nav">
                <h:link outcome="index" value="Home" styleClass="nav-item"/>
                <h:link outcome="faculties" value="Faculties" styleClass="nav-item"/>
                <h:link outcome="courses" value="Courses" styleClass="nav-item"/>
                <h:link outcome="students" value="Students" styleClass="nav-item"/>
                <h:link outcome="demoIndex" value="Feature Demos" styleClass="nav-item"/>
                <h:link outcome="optimisticLockingDemo" value="OptLock Demo" styleClass="nav-item current"/>
            </div>
        </div>

        <div class="content">
            <h2>Optimistic Locking Demonstration</h2>

            <h:messages globalOnly="true" infoClass="info-message" errorClass="error-message" warnClass="warning-message"/>

            <div class="info-box">
                <h3>About Optimistic Locking</h3>
                <p>Optimistic locking is a concurrency control method that allows multiple users to access the same
                    record for edits without locking it. It assumes conflicts are rare.</p>

                <h4>How It Works:</h4>
                <ol>
                    <li>Each entity has a <code>@Version</code> field that is automatically incremented on each update.</li>
                    <li>When updating, JPA checks if the version matches the database version.</li>
                    <li>If the versions don't match, an <code>OptimisticLockException</code> is thrown.</li>
                </ol>

                <h4>What Happens During OptimisticLockException:</h4>
                <ol>
                    <li>The current transaction is automatically marked for rollback.</li>
                    <li>The persistence context is cleared for the failed entity.</li>
                    <li>To recover, you need to:
                        <ul>
                            <li>Get a fresh copy of the entity from the database</li>
                            <li>Reapply your changes</li>
                            <li>Save the entity again</li>
                        </ul>
                    </li>
                </ol>
            </div>

            <!-- Step 1: Select a student -->
            <div class="form-section">
                <h3>Step 1: Select a Student to Edit</h3>

                <h:form id="selectStudentForm">
                    <h:dataTable value="#{studentBean.students}" var="student" styleClass="data-table"
                                 headerClass="table-header" rowClasses="table-row-odd, table-row-even">
                        <h:column>
                            <f:facet name="header">ID</f:facet>
                            #{student.id}
                        </h:column>

                        <h:column>
                            <f:facet name="header">Student ID</f:facet>
                            #{student.studentId}
                        </h:column>

                        <h:column>
                            <f:facet name="header">Name</f:facet>
                            #{student.firstName} #{student.lastName}
                        </h:column>

                        <h:column>
                            <f:facet name="header">Version</f:facet>
                            #{student.version}
                        </h:column>

                        <h:column>
                            <f:facet name="header">Action</f:facet>
                            <h:commandButton value="Select"
                                             action="#{optLockDemoBean.loadStudent(student.id)}"
                                             styleClass="button small"/>
                        </h:column>
                    </h:dataTable>
                </h:form>
            </div>

            <!-- Step 2: Edit the student -->
            <div class="form-section">
                <h3>Step 2: Edit the Student</h3>

                <h:form id="editStudentForm">
                    <div class="form-row">
                        <h:outputLabel for="studentId" value="Student ID:"/>
                        <h:outputText id="studentId" value="#{optLockDemoBean.selectedStudent.studentId}"/>
                    </div>

                    <div class="form-row">
                        <h:outputLabel for="version" value="Current Version:"/>
                        <h:outputText id="version" value="#{optLockDemoBean.selectedStudent.version}"/>
                    </div>

                    <div class="form-row">
                        <h:outputLabel for="firstName" value="First Name:"/>
                        <h:inputText id="firstName" value="#{optLockDemoBean.newFirstName}"
                                     disabled="#{empty optLockDemoBean.selectedStudent.id}"/>
                    </div>

                    <div class="form-row">
                        <h:outputLabel for="lastName" value="Last Name:"/>
                        <h:inputText id="lastName" value="#{optLockDemoBean.newLastName}"
                                     disabled="#{empty optLockDemoBean.selectedStudent.id}"/>
                    </div>
                </h:form>
            </div>

            <!-- Step 3: Simulate conflict and recovery -->
            <div class="form-section">
                <h3>Step 3: Demonstrate Optimistic Locking</h3>

                <h:form id="conflictForm">
                    <div class="form-actions">
                        <h:commandButton value="1. Simulate Concurrent Update"
                                         action="#{optLockDemoBean.simulateConcurrentUpdate()}"
                                         styleClass="button"
                                         disabled="#{empty optLockDemoBean.selectedStudent.id}"/>

                        <h:commandButton value="2. Recover from Conflict"
                                         action="#{optLockDemoBean.recoverFromConflict()}"
                                         styleClass="button"
                                         disabled="#{empty optLockDemoBean.selectedStudent.id or not optLockDemoBean.conflictOccurred}"/>

                        <h:commandButton value="3. Refresh Student List"
                                         action="#{studentBean.init()}"
                                         styleClass="button"/>
                    </div>

                    <h:panelGroup rendered="#{not empty optLockDemoBean.result}" styleClass="result-box">
                        <h4>Result:</h4>
                        <p>#{optLockDemoBean.result}</p>
                    </h:panelGroup>
                </h:form>
            </div>

            <div class="info-box">
                <h4>Detailed Explanation of the Demo</h4>
                <ol>
                    <li><strong>Select a student</strong> to edit from the table.</li>
                    <li><strong>Modify the name values</strong> as you wish.</li>
                    <li>Click <strong>"Simulate Concurrent Update"</strong> - this simulates another user modifying the same student record.</li>
                    <li>An <strong>OptimisticLockException</strong> should occur because the version number in the database no longer matches the version in your entity.</li>
                    <li>Click <strong>"Recover from Conflict"</strong> to demonstrate how to properly recover:
                        <ul>
                            <li>Get a fresh copy of the entity with the current version</li>
                            <li>Apply your changes to this fresh copy</li>
                            <li>Save the updated entity</li>
                        </ul>
                    </li>
                    <li>Click <strong>"Refresh Student List"</strong> to see the final updated version.</li>
                </ol>
            </div>
        </div>

        <div class="footer">
            <p>2025 University Management System</p>
        </div>
    </div>
</h:body>
</html>